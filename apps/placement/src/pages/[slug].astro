---
export const prerender = false;

import BaseLayout from '@quest/ui/layouts/base.astro';
import { initializeSql, getArticleBySlug } from '@quest/db';

// Initialize Neon - handle missing DATABASE_URL gracefully
const databaseUrl = import.meta.env.DATABASE_URL;
if (!databaseUrl) {
  throw new Error('DATABASE_URL environment variable is not set. Please add it in Vercel settings.');
}

initializeSql(databaseUrl);

const { slug } = Astro.params;
// Extract just first word of SITE_NAME for database query (e.g., "Placement Quest" -> "placement")
const siteName = (import.meta.env.SITE_NAME?.split(' ')[0] || 'placement').toLowerCase();
const article = await getArticleBySlug(siteName, slug || '');

if (!article) {
  return Astro.redirect('/404');
}
---

<BaseLayout
  title={article.title || article.headline_title}
  description={article.meta_description || article.excerpt || ''}
>
  <article class="mx-auto max-w-4xl px-4 py-8">
    <header class="mb-8">
      <h1 class="mb-4 text-4xl font-bold text-gray-900 dark:text-white">
        {article.title || article.headline_title}
      </h1>

      {article.excerpt && (
        <p class="text-xl text-gray-600 dark:text-gray-400 mb-4">
          {article.excerpt}
        </p>
      )}

      {article.featured_image_url && (
        <img
          src={article.featured_image_url}
          alt={article.title || article.headline_title}
          class="w-full rounded-lg"
        />
      )}

      <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-500 mt-4">
        {article.created_at && (
          <time datetime={article.created_at}>
            {new Date(article.created_at).toLocaleDateString('en-GB', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        )}
        {article.reading_time_minutes && (
          <>
            <span>â€¢</span>
            <span>{article.reading_time_minutes} min read</span>
          </>
        )}
      </div>
    </header>

    <div
      class="prose prose-lg dark:prose-invert max-w-none"
      set:html={article.article_body || article.content}
    />
  </article>
</BaseLayout>

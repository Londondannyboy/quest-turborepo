---
export const prerender = false;

import BaseLayout from '@quest/ui/layouts/base.astro';
import Header from '@quest/ui/components/Header.astro';
import Hero from '@quest/ui/components/Hero.astro';
import StatsSection from '@quest/ui/components/StatsSection.astro';
import WhatWeCover from '@quest/ui/components/WhatWeCover.astro';
import FAQSection from '@quest/ui/components/FAQSection.astro';
import CitiesCollection from '@quest/ui/components/CitiesCollection.astro';
import ContentSection from '@quest/ui/components/ContentSection.astro';
import ArticleCardFeatured from '@quest/ui/components/ArticleCardFeatured.astro';
import ArticleCardGrid from '@quest/ui/components/ArticleCardGrid.astro';
import Footer from '@quest/ui/components/Footer.astro';
import { initializeSql, getRecentArticles, getArticles } from '@quest/db';
import { detectGeo, formatCurrency } from '@quest/geo';

// Initialize Neon - handle missing DATABASE_URL gracefully
const databaseUrl = import.meta.env.DATABASE_URL;
if (!databaseUrl) {
  throw new Error('DATABASE_URL environment variable is not set. Please add it in Vercel settings.');
}

initializeSql(databaseUrl);

// Extract just first word of SITE_NAME for database query (e.g., "Placement Quest" -> "placement")
const siteName = (import.meta.env.SITE_NAME?.split(' ')[0] || 'placement').toLowerCase();
const recentArticles = await getRecentArticles(siteName, 10);

// Get featured companies for homepage
const featuredCompanies = await getArticles(siteName, {
  contentType: 'company_profile',
  limit: 6,
});

// Get site info from env with improved copy
const fullSiteName = import.meta.env.SITE_NAME || 'Placement Quest';
const siteTagline = import.meta.env.SITE_TAGLINE || 'Your Ultimate Guide to Private Equity Placement Agents & Fundraising';

// Separate featured article from grid
const featuredArticle = recentArticles?.[0];
const gridArticles = recentArticles?.slice(1) || [];

// Site stats (holistic, factually accurate)
const placementStats = [
  { number: 'Comprehensive', label: 'Industry Coverage', icon: 'building' },
  { number: 'Expert', label: 'Insights & Analysis', icon: 'document' },
  { number: 'Global', label: 'Market Intelligence', icon: 'chart' },
  { number: 'Multi-City', label: 'Geographic Reach', icon: 'globe' },
];

// Placement-specific topics
const placementTopics = [
  {
    title: 'Placement Agent Profiles',
    description: 'In-depth profiles of leading placement agents worldwide, including their expertise, track record, and specializations in private equity fundraising.',
    icon: 'users',
  },
  {
    title: 'Fundraising Strategies',
    description: 'Expert guidance on successful capital raising strategies, LP engagement, and market positioning for PE funds seeking institutional investors.',
    icon: 'strategy',
  },
  {
    title: 'Market Intelligence',
    description: 'Latest trends, deal flow analysis, and insights into the evolving private equity placement landscape across all asset classes.',
    icon: 'analytics',
  },
  {
    title: 'Regional Coverage',
    description: 'Comprehensive coverage of placement agents across key markets including US, Europe, Asia-Pacific, and emerging regions worldwide.',
    icon: 'globe',
  },
];

// Geo-location and currency
const userPrefs = detectGeo(Astro.request, {
  forceRegion: 'UK', // Placement is UK-focused
  showCurrencySelector: true,
});

// Key Cities for SEO
const keyCities = [
  { name: 'London', country: 'United Kingdom', slug: 'london', description: 'Europe\'s financial hub with the highest concentration of placement agents', count: 15, icon: 'ðŸ‡¬ðŸ‡§' },
  { name: 'New York', country: 'United States', slug: 'new-york', description: 'Global capital markets center and headquarters for leading PE placement firms', count: 12, icon: 'ðŸ‡ºðŸ‡¸' },
  { name: 'Hong Kong', country: 'China SAR', slug: 'hong-kong', description: 'Asia-Pacific gateway for cross-border private equity fundraising', count: 8, icon: 'ðŸ‡­ðŸ‡°' },
  { name: 'Singapore', country: 'Singapore', slug: 'singapore', description: 'Southeast Asia\'s premier financial center for alternative investments', count: 6, icon: 'ðŸ‡¸ðŸ‡¬' },
  { name: 'Paris', country: 'France', slug: 'paris', description: 'Continental Europe\'s leading market for placement agent services', count: 5, icon: 'ðŸ‡«ðŸ‡·' },
  { name: 'Frankfurt', country: 'Germany', slug: 'frankfurt', description: 'Germany\'s financial capital with strong institutional investor base', count: 4, icon: 'ðŸ‡©ðŸ‡ª' },
];

// FAQ Data
const placementFAQs = [
  {
    question: 'What percentage of private equity funds use placement agents?',
    answer: 'Approximately 40-60% of all private equity fundraises involve placement agents. The percentage varies significantly by fund size and manager experience. First-time and emerging managers use placement agents in 70-80% of cases, while established mega-funds ($5B+) often fundraise without placement support. Mid-market funds ($250M-$1B) represent the sweet spot where <a href="/articles" class="text-primary hover:underline">placement agents provide maximum value</a>.'
  },
  {
    question: 'How much do placement agents typically charge?',
    answer: `Placement agent fees generally range from 1.5-3% of total capital raised. Large-cap funds ($1B+) typically pay 1.5-2%, mid-market funds pay 2-2.5%, and smaller funds pay 2.5-3%. For a ${formatCurrency(500000000, userPrefs.currency)} fund, total placement costs would be approximately ${formatCurrency(12500000, userPrefs.currency)} (2.5% fee). Learn more about <a href="/fee-structures" class="text-primary hover:underline">placement agent fee structures</a>.`
  },
  {
    question: 'Should first-time fund managers hire a placement agent?',
    answer: 'First-time fund managers almost always benefit from placement agent engagement. Without established LP relationships or fundraising track records, emerging managers face significant challenges accessing institutional capital. <a href="/emerging-managers" class="text-primary hover:underline">Placement agents</a> provide credibility, LP access, fundraising expertise, and professional materials that dramatically improve success probabilities.'
  },
  {
    question: 'How long does a typical fundraise take with a placement agent?',
    answer: 'A typical institutional fundraise with a placement agent runs 9-18 months from initial engagement to final close. Established managers with strong track records can often complete fundraises in 9-12 months, while first-time managers or complex strategies may require 15-18 months. View our <a href="/top-agents" class="text-primary hover:underline">top placement agents</a> for more details.'
  },
  {
    question: 'What are the best placement agents in London?',
    answer: 'Leading London-based placement agents include <a href="/campbell-lutyens" class="text-primary hover:underline">Campbell Lutyens</a>, <a href="/park-hill-group" class="text-primary hover:underline">Park Hill Group</a>, <a href="/evercore" class="text-primary hover:underline">Evercore</a>, and <a href="/lazard" class="text-primary hover:underline">Lazard</a>. Browse all <a href="/cities/london" class="text-primary hover:underline">London placement agents</a>.'
  },
];

// How Placement Works Content
const howItWorksBlocks = [
  {
    heading: 'Initial Assessment (4-6 weeks)',
    content: 'Placement agents conduct comprehensive due diligence on the GP, investment strategy, track record, and competitive positioning. This includes analysis of historical fund performance, team composition, investment process, and fund terms relative to market standards.',
    links: [
      { text: 'View Top Placement Agents', href: '/top-agents' },
      { text: 'Selection Criteria Guide', href: '/selection-guide' },
    ]
  },
  {
    heading: 'Materials Development (6-8 weeks)',
    content: 'Working with the GP team, the placement agent coordinates development of all fundraising materials including Private Placement Memorandum (PPM), marketing presentations, due diligence questionnaires (DDQ), track record documentation, and term sheets.',
    links: [
      { text: 'Fundraising Materials Guide', href: '/materials' },
    ]
  },
  {
    heading: 'LP Outreach & Roadshow (12-16 weeks)',
    content: 'The placement agent leverages institutional relationships to identify and approach appropriate LP prospects, generating 50-150 initial conversations for institutional-quality mandates. A typical fundraise involves 40-80 substantive LP meetings over 3-4 months.',
    links: [
      { text: 'LP Targeting Strategies', href: '/lp-targeting' },
      { text: 'Browse by City', href: '#cities' },
    ]
  },
];
---

<BaseLayout title={fullSiteName} description={siteTagline}>
  <!-- Header -->
  <Header siteName={fullSiteName} />

  <!-- Hero Section -->
  <Hero siteName={fullSiteName} siteTagline={siteTagline} />

  <!-- Stats Section -->
  <StatsSection
    stats={placementStats}
    heading="Comprehensive Industry Resource"
    subheading="In-depth coverage of private equity placement agents and fundraising strategies"
  />

  <!-- Main Content -->
  <main class="mx-auto max-w-7xl px-4 lg:px-8 py-12 lg:py-16">
    {/* Featured Article Section */}
    {featuredArticle && (
      <section class="mb-16">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-3xl lg:text-4xl font-bold">Featured Story</h2>
        </div>
        <ArticleCardFeatured article={featuredArticle} />
      </section>
    )}

    {/* Top Placement Agents Section */}
    {featuredCompanies.length > 0 && (
      <section class="mb-20">
        <div class="flex items-center justify-between mb-10">
          <div>
            <h2 class="text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-3">Top Placement Agents</h2>
            <p class="text-lg text-gray-600 dark:text-gray-400">Leading firms helping PE funds raise capital worldwide</p>
          </div>
          <a href="/top-agents" class="inline-flex items-center gap-2 px-4 py-2 text-primary border-2 border-primary rounded-lg hover:bg-primary hover:text-white transition-colors">
            View All
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {featuredCompanies.map((company, index) => (
            <div class={`animate-fade-in-up animation-delay-${Math.min(index, 3) * 100}`}>
              <a href={`/${company.slug}`} class="block group">
                <article class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl shadow-xl hover:shadow-2xl transition-all duration-500 overflow-hidden border-2 border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary h-full transform hover:-translate-y-2">
                  <div class="p-6">
                    {company.featured_image_url && (
                      <div class="mb-4 aspect-video overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-700">
                        <img
                          src={company.featured_image_url}
                          alt={company.title || company.headline_title}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                          loading="lazy"
                        />
                      </div>
                    )}
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2 group-hover:text-primary transition-colors">
                      {company.title || company.headline_title}
                    </h3>
                    {company.excerpt && (
                      <p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-2 mb-4">
                        {company.excerpt.replace(/<[^>]*>/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')}
                      </p>
                    )}
                    <div class="flex items-center gap-2 text-xs text-primary font-semibold">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
                      </svg>
                      <span>View Profile â†’</span>
                    </div>
                  </div>
                </article>
              </a>
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  {/* What We Cover Section */}
  <WhatWeCover
    topics={placementTopics}
    heading="What We Cover"
    subheading="Everything you need to know about private equity placement agents and fundraising success"
    ctaText="Explore All Placement Agent Content"
    ctaLink="/articles"
  />

  {/* How Placement Agents Work Section */}
  <ContentSection
    title="How Private Equity Placement Agents Work"
    intro="Understanding the placement agent engagement process is critical for fund managers considering whether to hire a private equity placement agent and how to maximize the relationship. The typical engagement follows a structured six-phase process:"
    blocks={howItWorksBlocks}
    ctaText="Read Full Guide"
    ctaLink="/how-it-works"
  />

  {/* Key Cities Collection */}
  <div id="cities">
    <CitiesCollection
      cities={keyCities}
      heading="Browse Top Placement Agents by City"
      subheading="Discover leading placement agents in major financial centers worldwide"
      basePath="/cities"
    />
  </div>

  {/* FAQ Section with Schema */}
  <FAQSection
    faqs={placementFAQs}
    heading="Frequently Asked Questions"
    subheading="Common questions about private equity placement agents and the fundraising process"
  />

  <!-- Continue Main Content -->
  <main class="mx-auto max-w-7xl px-4 lg:px-8 py-12 lg:py-16">
    {/* Recent Articles Grid */}
    {gridArticles.length > 0 && (
      <section>
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white">Recent Articles</h2>
          <a href="/articles" class="inline-flex items-center gap-2 px-4 py-2 text-primary border-2 border-primary rounded-lg hover:bg-primary hover:text-white transition-colors">
            View All
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {gridArticles.map((article, index) => (
            <div class={`animate-fade-in-up animation-delay-${Math.min(index, 3) * 100}`}>
              <ArticleCardGrid article={article} />
            </div>
          ))}
        </div>
      </section>
    )}
  </main>

  <!-- Footer -->
  <Footer siteName={fullSiteName} />
</BaseLayout>

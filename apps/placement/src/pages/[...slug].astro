---
export const prerender = false;

import BaseLayout from '@quest/ui/layouts/base.astro';
import Header from '@quest/ui/components/Header.astro';
import Footer from '@quest/ui/components/Footer.astro';
import { initializeSql, getArticleBySlug } from '@quest/db';
import { marked } from 'marked';

// Initialize Neon - handle missing DATABASE_URL gracefully
const databaseUrl = import.meta.env.DATABASE_URL;
if (!databaseUrl) {
  throw new Error('DATABASE_URL environment variable is not set. Please add it in Vercel settings.');
}

initializeSql(databaseUrl);

// Handle rest parameter [...slug] - could be string or string[]
const slugParam = Astro.params.slug;
const slug = Array.isArray(slugParam) ? slugParam[0] : slugParam;

// Extract just first word of SITE_NAME for database query (e.g., "Placement Quest" -> "placement")
const fullSiteName = import.meta.env.SITE_NAME || 'Placement Quest';
const siteName = (fullSiteName.split(' ')[0] || 'placement').toLowerCase();

// Add error handling to catch database issues
let article;
try {
  article = await getArticleBySlug(siteName, slug || '');
} catch (error) {
  console.error(`Error fetching article for slug "${slug}":`, error);
  return Astro.redirect('/404');
}

if (!article) {
  console.log(`Article not found for site="${siteName}", slug="${slug}"`);
  return Astro.redirect('/404');
}

// Format publish date
const publishDate = article.created_at
  ? new Date(article.created_at).toLocaleDateString('en-GB', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : '';

// Convert markdown to HTML
const articleContent = article.article_body || article.content || '';
const htmlContent = await marked(articleContent, {
  breaks: true, // Convert line breaks to <br>
  gfm: true, // GitHub Flavored Markdown
});
---

<BaseLayout
  title={article.title || article.headline_title}
  description={article.meta_description || article.excerpt || ''}
  image={article.featured_image_url}
  article={true}
  publishedTime={article.created_at}
  modifiedTime={article.updated_at}
>
  <!-- Header -->
  <Header siteName={fullSiteName} />

  <!-- Article Hero Section -->
  <article class="bg-white dark:bg-gray-900">
    <!-- Featured Image Hero -->
    {article.featured_image_url && (
      <div class="relative h-[50vh] lg:h-[60vh] overflow-hidden bg-gray-900">
        <img
          src={article.featured_image_url}
          alt={article.title || article.headline_title}
          class="w-full h-full object-cover opacity-60"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>

        <!-- Title Overlay on Image -->
        <div class="absolute inset-0 flex items-end">
          <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 w-full">
            <h1 class="text-4xl lg:text-5xl xl:text-6xl font-bold text-white mb-4 leading-tight">
              {article.title || article.headline_title}
            </h1>
            <div class="flex items-center gap-4 text-sm text-gray-200">
              {publishDate && <time datetime={article.created_at}>{publishDate}</time>}
              {article.reading_time_minutes && (
                <>
                  <span>•</span>
                  <span>{article.reading_time_minutes} min read</span>
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- No Image: Traditional Header -->
    {!article.featured_image_url && (
      <header class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-8">
        <h1 class="text-4xl lg:text-5xl xl:text-6xl font-bold text-gray-900 dark:text-white mb-6 leading-tight">
          {article.title || article.headline_title}
        </h1>
        <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
          {publishDate && <time datetime={article.created_at}>{publishDate}</time>}
          {article.reading_time_minutes && (
            <>
              <span>•</span>
              <span>{article.reading_time_minutes} min read</span>
            </>
          )}
        </div>
      </header>
    )}

    <!-- Article Body -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="article-content" set:html={htmlContent} />
    </div>

    <!-- Back to Articles Link -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
      <a
        href="/"
        class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Home
      </a>
    </div>
  </article>

  <!-- Footer -->
  <Footer siteName={fullSiteName} />
</BaseLayout>

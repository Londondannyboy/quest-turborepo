---
import { getThemeName } from '../utils/theme';
import CookieConsent from '@jop-software/astro-cookieconsent';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  image?: string;
  article?: boolean;
  publishedTime?: string;
  modifiedTime?: string;
}

const { title, description, image, article = false, publishedTime, modifiedTime } = Astro.props;

// Get theme from environment
const themeVariant = import.meta.env.THEME_VARIANT || 'financial';
const defaultTheme = getThemeName(themeVariant, false);

// Get site info
const siteName = import.meta.env.SITE_NAME || 'Quest';
const siteUrl = Astro.site?.toString() || Astro.url.origin;
const currentUrl = new URL(Astro.url.pathname, siteUrl).toString();

// Default OG image if none provided
const ogImage = image || `${siteUrl}/og-default.jpg`;
---

<!doctype html>
<html lang="en" data-theme={defaultTheme}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={currentUrl} />

    <!-- OpenGraph / Facebook -->
    <meta property="og:type" content={article ? 'article' : 'website'} />
    <meta property="og:url" content={currentUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content={siteName} />
    {article && publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {article && modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={currentUrl} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Link Preview Support -->
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <link rel="preconnect" href="https://api.microlink.io" />
    <link rel="dns-prefetch" href="https://api.microlink.io" />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': article ? 'Article' : 'WebSite',
      'headline': title,
      'description': description,
      'url': currentUrl,
      'image': ogImage,
      'publisher': {
        '@type': 'Organization',
        'name': siteName,
        'url': siteUrl
      },
      ...(article && publishedTime ? { 'datePublished': publishedTime } : {}),
      ...(article && modifiedTime ? { 'dateModified': modifiedTime } : {})
    })} />

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Theme persistence script -->
    <script is:inline>
      // Load saved theme or use default
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
    </script>
  </head>
  <body class="min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <slot />

    <!-- Cookie Consent (GDPR compliant) -->
    <CookieConsent
      guiOptions={{
        consentModal: {
          layout: 'box',
          position: 'bottom right'
        }
      }}
      categories={{
        necessary: {
          enabled: true,
          readOnly: true
        },
        analytics: {
          enabled: false,
          readOnly: false
        }
      }}
      language={{
        default: 'en',
        translations: {
          en: {
            consentModal: {
              title: "We value your privacy",
              description: "We use cookies to enhance your browsing experience and analyze site traffic. You can customize your preferences below.",
              acceptAllBtn: "Accept all",
              acceptNecessaryBtn: "Reject all",
              showPreferencesBtn: "Manage preferences"
            },
            preferencesModal: {
              title: "Cookie preferences",
              acceptAllBtn: "Accept all",
              acceptNecessaryBtn: "Reject all",
              savePreferencesBtn: "Save preferences",
              sections: [
                {
                  title: "Strictly Necessary cookies",
                  description: "These cookies are essential for the proper functioning of the website.",
                  linkedCategory: "necessary"
                },
                {
                  title: "Analytics cookies",
                  description: "These cookies help us understand how visitors interact with our website.",
                  linkedCategory: "analytics"
                }
              ]
            }
          }
        }
      }}
    />
  </body>
</html>
